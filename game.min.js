const app=new PIXI.Application({width:window.innerWidth,height:window.innerHeight,transparent:!0,resizeTo:window});document.getElementById("gameContainer").appendChild(app.view);const mainContainer=new PIXI.Container;app.stage.addChild(mainContainer);class LayerManager{constructor(layerOrder){this.layers={},this.container=new PIXI.Container,this.layerOrder=layerOrder,layerOrder.forEach(layerName=>{this.layers[layerName]=new PIXI.Container,this.container.addChild(this.layers[layerName])})}async loadResource(layerName,resourceUrl){const layer=this.layers[layerName];if(!layer)return null;layer.removeChildren();const texture=await PIXI.Texture.fromURL(resourceUrl),sprite=new PIXI.Sprite(texture);sprite.anchor.set(.5,0),sprite.position.set(0,0);const scale=Math.min(400/texture.width,600/texture.height)||1;return sprite.scale.set(scale),sprite.anchor.set(.5,0),sprite.position.set(0,0),layer.addChild(sprite),sprite}setLayerVisibility(layerName,visible){this.layers[layerName]&&(this.layers[layerName].visible=visible)}getLayer(layerName){return this.layers[layerName]}}const layerOrder=["background","hair","body","clothes","foreground"],layerManager=new LayerManager(layerOrder);mainContainer.addChild(layerManager.container);const resources={body:["images/body/开心表情+白裤袜.png","images/body/普通表情+白小腿袜.png","images/body/普通表情+裸腿.png","images/body/普通表情+过膝白丝.png","images/body/普通表情+黑裤袜.png","images/body/普通表情+黑过膝.png","images/body/生气表情+白小腿袜.png"],hair:["images/hair/双马尾.png","images/hair/披发.png","images/hair/短发.png","images/hair/高马尾.png"],clothes:["images/clothes/体操服.png","images/clothes/公式服.png","images/clothes/女仆装.png","images/clothes/泳衣.png","images/clothes/鲸鱼服装.png"]},currentSelection={clothes:0,body:0,hair:0};let originalWidth,originalHeight,currentScale=1;const headerRatio=.1;async function loadInitialResources(){try{const bodyTexture_=await PIXI.Texture.fromURL(resources.body[0]);originalWidth=bodyTexture_.width,originalHeight=bodyTexture_.height}catch(error){originalWidth=800,originalHeight=1200}const targetWidth=.9*window.innerWidth,targetHeight=.8*window.innerHeight,scaleX=targetWidth/originalWidth,scaleY=targetHeight/originalHeight;currentScale=Math.min(scaleX,scaleY),mainContainer.scale.set(currentScale);const bounds=mainContainer.getBounds();mainContainer.pivot.set(bounds.width/2,0),mainContainer.position.set(app.screen.width/2,0),await layerManager.loadResource("background","images/background/背景.png"),await layerManager.loadResource("foreground","images/background/前景.png"),await layerManager.loadResource("body",resources.body[0]),await layerManager.loadResource("hair",resources.hair[0]),await layerManager.loadResource("clothes",resources.clothes[0]),updateControlPanelPreviews(),setDefaultMiddleSelection()}function getDLCItems(){return["./hair/短发.png","./clothes/鲸鱼服装.png","./clothes/女仆装.png","./body/普通表情+黑过膝.png","./body/生气表情+白小腿袜.png","./body/开心表情+白裤袜.png"]}function generateControlPanels(){const dlcItems=getDLCItems();["body","clothes","hair"].forEach(type=>{const inner=document.querySelector(`#${type}Panel .panel-inner`),count=resources[type].length;inner.innerHTML="";for(let copy=0;copy<3;copy++)for(let i=0;i<count;i++){const item=document.createElement("div"),resourcePath=resources[type][i],isDLC=dlcItems.some(dlcPath=>resourcePath.includes(dlcPath.split("/").pop()));if(item.className="control-item",isDLC&&item.classList.add("dlc-item"),item.dataset.type=type,item.dataset.index=i,item.style.backgroundImage=`url(${resourcePath})`,isDLC){const dlcLabel=document.createElement("span");dlcLabel.className="dlc-label",dlcLabel.textContent="DLC",item.appendChild(dlcLabel)}inner.appendChild(item)}})}async function updateControlPanelPreviews(){generateControlPanels()}function setDefaultMiddleSelection(){["body","clothes","hair"].forEach(type=>{const count=resources[type].length;if(0===count)return;const middleIndex=Math.floor((count-1)/2);currentSelection[type]=middleIndex;const panelInner=document.querySelector(`#${type}Panel .panel-inner`),totalWidth=76*count,scrollPosition=76*middleIndex+38-panelInner.offsetWidth/2+totalWidth;panelInner.scrollLeft=scrollPosition;document.querySelectorAll(`.control-item[data-type="${type}"]`).forEach((item,index)=>{const actualIndex=index%count;item.classList.toggle("active",actualIndex===middleIndex)}),loadSelectedResource(type,middleIndex)})}let isWearingWhaleClothes=!1;async function loadSelectedResource(type,index){await layerManager.loadResource(type,resources[type][index]),"clothes"===type?(isWearingWhaleClothes=resources.clothes[index].includes("鲸鱼服装.png"),layerManager.setLayerVisibility("hair",!isWearingWhaleClothes)):"hair"===type&&layerManager.setLayerVisibility("hair",!isWearingWhaleClothes)}function randomDressUp(){["body","clothes","hair"].forEach(type=>{const count=resources[type].length;if(count>0){const randomIndex=Math.floor(Math.random()*count);currentSelection[type]=randomIndex,loadSelectedResource(type,randomIndex);document.querySelectorAll(`.control-item[data-type="${type}"]`).forEach((item,idx)=>{const actualIndex=idx%count;item.classList.toggle("active",actualIndex===randomIndex)});const panelInner=document.querySelector(`#${type}Panel .panel-inner`),itemWidth=76,totalWidth=count*itemWidth,centeredPos=randomIndex*itemWidth+itemWidth/2-panelInner.offsetWidth/2,positions=[centeredPos+totalWidth,centeredPos,centeredPos+2*totalWidth],distances=positions.map(pos=>Math.abs(pos-panelInner.scrollLeft)),nearestPos=positions[distances.indexOf(Math.min(...distances))];panelInner.scrollTo({left:nearestPos,behavior:"smooth"})}});const btn=document.getElementById("randomBtn");btn.style.transform="scale(0.95)",setTimeout(()=>{btn.style.transform=""},150)}function initInfiniteScroll(){["body","clothes","hair"].forEach(type=>{const panelInner=document.querySelector(`#${type}Panel .panel-inner`);if(!panelInner)return;const originalCount=resources[type].length;if(0===originalCount)return;const contentWidth=76*originalCount;let isTeleporting=!1;panelInner.addEventListener("scroll",()=>{if(isTeleporting)return void(isTeleporting=!1);const scrollLeft=panelInner.scrollLeft;scrollLeft<contentWidth?(isTeleporting=!0,panelInner.scrollLeft+=contentWidth):scrollLeft>=2*contentWidth&&(isTeleporting=!0,panelInner.scrollLeft-=contentWidth)})})}document.addEventListener("click",async e=>{if(e.target.classList.contains("control-item")){const type=e.target.dataset.type,clickedIndex=parseInt(e.target.dataset.index),originalCount=resources[type].length;currentSelection[type]=clickedIndex,document.querySelectorAll(`.control-item[data-type="${type}"]`).forEach(el=>el.classList.remove("active")),document.querySelectorAll(`.control-item[data-type="${type}"]`).forEach((el,idx)=>{idx%originalCount===clickedIndex&&el.classList.add("active")});const panelInner=e.target.closest(".panel-inner"),panel=panelInner.closest(".control-panel"),itemWidth=76,totalWidth=originalCount*itemWidth,currentPos=panelInner.scrollLeft,panelWidth=panel.offsetWidth,centeredPos=clickedIndex*itemWidth+itemWidth/2-panelWidth/2,positions=[centeredPos+totalWidth,centeredPos,centeredPos+2*totalWidth],distances=positions.map(pos=>Math.abs(pos-currentPos)),nearestPos=positions[distances.indexOf(Math.min(...distances))];panelInner.scrollTo({left:nearestPos+50,behavior:"smooth"}),loadSelectedResource(type,clickedIndex)}}),document.addEventListener("DOMContentLoaded",()=>{const randomBtn=document.getElementById("randomBtn");randomBtn&&randomBtn.addEventListener("click",randomDressUp);const themeToggleBtn=document.getElementById("themeToggleBtn"),body=document.body,themeIcon=themeToggleBtn.querySelector(".btn-icon");themeToggleBtn.addEventListener("click",()=>{body.classList.toggle("dark-mode"),body.classList.contains("dark-mode")?(themeIcon.textContent="☀️",themeToggleBtn.title="切换日间模式"):(themeIcon.textContent="🌙",themeToggleBtn.title="切换夜间模式")})}),loadInitialResources(),initInfiniteScroll(),window.addEventListener("resize",()=>{app.renderer.resize(window.innerWidth,window.innerHeight);const targetWidth=.9*window.innerWidth,targetHeight=.8*window.innerHeight,scaleX=targetWidth/originalWidth,scaleY=targetHeight/originalHeight;currentScale=Math.min(scaleX,scaleY),mainContainer.scale.set(currentScale);const bounds=mainContainer.getBounds();mainContainer.pivot.set(bounds.width/2,0),mainContainer.position.set(app.screen.width/2,0)});