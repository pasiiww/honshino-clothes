const app=new PIXI.Application({width:window.innerWidth,height:window.innerHeight,backgroundColor:16777215,resizeTo:window});document.getElementById("gameContainer").appendChild(app.view);const layers={background:new PIXI.Container,foreground:new PIXI.Container,hair:new PIXI.Container,body:new PIXI.Container,clothes:new PIXI.Container},mainContainer=new PIXI.Container;app.stage.addChild(mainContainer);class LayerManager{constructor(layerOrder){this.layers={},this.container=new PIXI.Container,this.layerOrder=layerOrder,layerOrder.forEach(layerName=>{this.layers[layerName]=new PIXI.Container,this.container.addChild(this.layers[layerName])})}async loadResource(layerName,resourceUrl){const layer=this.layers[layerName];if(!layer)return null;layer.removeChildren();const texture=await PIXI.Texture.fromURL(resourceUrl),sprite=new PIXI.Sprite(texture);sprite.anchor.set(.5,0),sprite.position.set(0,0);const scale=Math.min(400/texture.width,600/texture.height)||1;return sprite.scale.set(scale),layer.addChild(sprite),sprite}setLayerVisibility(layerName,visible){this.layers[layerName]&&(this.layers[layerName].visible=visible)}getLayer(layerName){return this.layers[layerName]}}const layerOrder=["background","hair","body","clothes","foreground"],layerManager=new LayerManager(layerOrder);mainContainer.addChild(layerManager.container),mainContainer.addChild(layers.background),mainContainer.addChild(layers.hair),mainContainer.addChild(layers.body),mainContainer.addChild(layers.clothes),mainContainer.addChild(layers.foreground);const resources={body:["images/body/开心表情+白裤袜.png","images/body/普通表情+白小腿袜.png","images/body/普通表情+裸腿.png","images/body/普通表情+过膝白丝.png","images/body/普通表情+黑裤袜.png","images/body/普通表情+黑过膝.png","images/body/生气表情+白小腿袜.png"],hair:["images/hair/双马尾.png","images/hair/披发.png","images/hair/短发.png","images/hair/高马尾.png"],clothes:["images/clothes/体操服.png","images/clothes/公式服.png","images/clothes/女仆装.png","images/clothes/泳衣.png","images/clothes/鲸鱼服装.png"]},currentSelection={clothes:0,body:0,hair:0};let originalWidth,originalHeight,currentScale=1;const headerRatio=.1;async function loadInitialResources(){try{const bodyTexture_=await PIXI.Texture.fromURL(resources.body[0]);originalWidth=bodyTexture_.width,originalHeight=bodyTexture_.height}catch(error){originalWidth=800,originalHeight=1200}const targetWidth=.9*window.innerWidth,targetHeight=.8*window.innerHeight,scaleX=targetWidth/originalWidth,scaleY=targetHeight/originalHeight;currentScale=Math.min(scaleX,scaleY),mainContainer.scale.set(currentScale);const bounds=mainContainer.getBounds();mainContainer.pivot.set(bounds.width/2,0),mainContainer.position.set(app.screen.width/2,0),await layerManager.loadResource("background","images/background/背景.png"),await layerManager.loadResource("foreground","images/background/前景.png"),await layerManager.loadResource("foreground","images/background/前景2.png"),await layerManager.loadResource("body",resources.body[0]),await layerManager.loadResource("hair",resources.hair[0]),await layerManager.loadResource("clothes",resources.clothes[0]),updateControlPanelPreviews()}function getDLCItems(){return["./hair/短发.png","./clothes/鲸鱼服装.png","./clothes/女仆装.png","./body/普通表情+黑过膝.png","./body/生气表情+白小腿袜.png","./body/开心表情+白裤袜.png"]}function generateControlPanels(){const dlcItems=getDLCItems();["body","clothes","hair"].forEach(type=>{const inner=document.querySelector(`#${type}Panel .panel-inner`),count=resources[type].length;inner.innerHTML="";for(let copy=0;copy<3;copy++)for(let i=0;i<count;i++){const item=document.createElement("div"),resourcePath=resources[type][i],isDLC=dlcItems.some(dlcPath=>resourcePath.includes(dlcPath.split("/").pop()));if(item.className="control-item",isDLC&&item.classList.add("dlc-item"),item.dataset.type=type,item.dataset.index=i,item.style.backgroundImage=`url(${resourcePath})`,isDLC){const dlcLabel=document.createElement("span");dlcLabel.className="dlc-label",dlcLabel.textContent="DLC",item.appendChild(dlcLabel)}inner.appendChild(item)}})}async function updateControlPanelPreviews(){generateControlPanels(),setDefaultMiddleSelection()}function setDefaultMiddleSelection(){["body","clothes","hair"].forEach(type=>{const count=resources[type].length;if(0===count)return;const middleIndex=Math.floor((count-1)/2);currentSelection[type]=middleIndex;const panelInner=document.querySelector(`#${type}Panel .panel-inner`),scrollPosition=76*count+76*middleIndex;panelInner.scrollLeft=scrollPosition;document.querySelectorAll(`.control-item[data-type="${type}"]`).forEach((item,index)=>{const actualIndex=index%count;item.classList.toggle("active",actualIndex===middleIndex)}),loadSelectedResource(type,middleIndex)})}initInfiniteScroll();let isWearingWhaleClothes=!1;async function loadSelectedResource(type,index){await layerManager.loadResource(type,resources[type][index]),"clothes"===type?(isWearingWhaleClothes=resources.clothes[index].includes("鲸鱼服装.png"),layerManager.setLayerVisibility("hair",!isWearingWhaleClothes)):"hair"===type&&layerManager.setLayerVisibility("hair",!isWearingWhaleClothes)}function randomDressUp(){["body","clothes","hair"].forEach(type=>{const count=resources[type].length;if(count>0){const randomIndex=Math.floor(Math.random()*count);currentSelection[type]=randomIndex,loadSelectedResource(type,randomIndex);document.querySelectorAll(`.control-item[data-type="${type}"]`).forEach((item,idx)=>{const actualIndex=idx%count;item.classList.toggle("active",actualIndex===randomIndex)});const panelInner=document.querySelector(`#${type}Panel .panel-inner`),itemWidth=76,totalWidth=count*itemWidth,centeredPos=randomIndex*itemWidth+itemWidth/2-panelInner.offsetWidth/2,positions=[centeredPos+totalWidth,centeredPos,centeredPos+2*totalWidth],distances=positions.map(pos=>Math.abs(pos-panelInner.scrollLeft)),nearestPos=positions[distances.indexOf(Math.min(...distances))];panelInner.scrollTo({left:nearestPos,behavior:"smooth"})}});const btn=document.getElementById("randomBtn");btn.style.transform="scale(0.95)",setTimeout(()=>{btn.style.transform=""},150)}function initInfiniteScroll(){["body","clothes","hair"].forEach(type=>{const panel=document.getElementById(`${type}Panel`),inner=panel.querySelector(".panel-inner"),originalCount=resources[type].length;let startX,startY,scrollLeft,initialScrollTop,isDragging=!1;const middleSectionCenter=76*originalCount+76*Math.floor(originalCount/2);inner.scrollLeft=middleSectionCenter,panel.addEventListener("mousedown",e=>{if(0!==e.button)return;isDragging=!0,startX=e.pageX-panel.offsetLeft,startY=e.pageY,scrollLeft=inner.scrollLeft,initialScrollTop=window.pageYOffset||document.documentElement.scrollTop,e.preventDefault();const handleGlobalMouseUp=()=>{isDragging&&(isDragging=!1,handleDragEnd()),document.removeEventListener("mouseup",handleGlobalMouseUp)};document.addEventListener("mouseup",handleGlobalMouseUp)}),panel.addEventListener("mousemove",e=>{if(!isDragging||1!==e.buttons)return;e.preventDefault(),e.stopPropagation();const x=e.pageX-panel.offsetLeft,walk=1*(startX-x);Math.abs(e.pageY-startY)>5&&window.scrollTo(0,initialScrollTop),inner.scrollLeft=scrollLeft+walk}),panel.addEventListener("mouseup",()=>{isDragging&&(isDragging=!1,handleDragEnd())}),panel.addEventListener("mouseleave",()=>{isDragging&&(isDragging=!1,handleDragEnd())}),panel.addEventListener("touchstart",e=>{const touch=e.touches[0];startX=touch.pageX-panel.offsetLeft,startY=touch.pageY,scrollLeft=inner.scrollLeft,initialScrollTop=window.pageYOffset||document.documentElement.scrollTop}),panel.addEventListener("touchmove",e=>{const touch=e.touches[0],moveX=Math.abs(touch.pageX-startX),moveY=Math.abs(touch.pageY-startY);if(moveX>10||moveY>10){isDragging||(isDragging=!0,e.preventDefault());const x=touch.pageX-panel.offsetLeft,walk=1*(startX-x);Math.abs(touch.pageY-startY)>5&&window.scrollTo(0,initialScrollTop),inner.scrollLeft=scrollLeft+walk}}),panel.addEventListener("touchend",()=>{if(isDragging)isDragging=!1,handleDragEnd();else{const touch=e.changedTouches[0],target=document.elementFromPoint(touch.clientX,touch.clientY).closest(".control-item");if(target){const index=Array.from(inner.querySelectorAll(".control-item")).indexOf(target);if(-1!==index){const originalIndex=index%originalCount;updateSelection(originalIndex);const targetPosition=76*originalIndex-(inner.clientWidth-76)/2;inner.scrollTo({left:targetPosition,behavior:"smooth"})}}}}),inner.addEventListener("click",e=>{const target=e.target.closest(".control-item");if(target){const index=Array.from(inner.querySelectorAll(".control-item")).indexOf(target);if(-1!==index){const originalIndex=index%originalCount;updateSelection(originalIndex);const targetPosition=76*originalIndex-(inner.clientWidth-76)/2;inner.scrollTo({left:targetPosition,behavior:"smooth"})}}})})}document.addEventListener("click",async e=>{if(e.target.classList.contains("control-item")){const type=e.target.dataset.type,clickedIndex=parseInt(e.target.dataset.index),originalCount=resources[type].length;currentSelection[type]=clickedIndex,document.querySelectorAll(`.control-item[data-type="${type}"]`).forEach(el=>el.classList.remove("active")),document.querySelectorAll(`.control-item[data-type="${type}"]`).forEach((el,idx)=>{idx%originalCount===clickedIndex&&el.classList.add("active")});const panelInner=e.target.closest(".panel-inner"),panel=panelInner.closest(".control-panel"),itemWidth=76,totalWidth=originalCount*itemWidth,currentPos=panelInner.scrollLeft,panelWidth=panel.offsetWidth,centeredPos=clickedIndex*itemWidth+itemWidth/2-panelWidth/2,positions=[centeredPos+totalWidth,centeredPos,centeredPos+2*totalWidth],distances=positions.map(pos=>Math.abs(pos-currentPos)),nearestPos=positions[distances.indexOf(Math.min(...distances))];panelInner.scrollTo({left:nearestPos,behavior:"smooth"}),loadSelectedResource(type,clickedIndex)}}),document.addEventListener("DOMContentLoaded",()=>{const randomBtn=document.getElementById("randomBtn");randomBtn&&randomBtn.addEventListener("click",randomDressUp)}),loadInitialResources(),window.addEventListener("resize",()=>{if(originalWidth&&originalHeight){const targetWidth=.9*app.screen.width,targetHeight=.8*app.screen.height,scaleX=targetWidth/originalWidth,scaleY=targetHeight/originalHeight,currentScale=Math.min(scaleX,scaleY);mainContainer.scale.set(currentScale);const bounds=mainContainer.getBounds();mainContainer.pivot.set(bounds.width/2,0),mainContainer.position.set(app.screen.width/2,0)}});